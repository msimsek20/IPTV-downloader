<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xstream Pro Downloader</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121926; --muted:#93a4bd; --text:#e7eefc; --accent:#7aa2ff; --danger:#ff6b6b; --ok:#4ade80; --warn:#ffd36b; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); font-size:13px; overflow:hidden; }
    
    .app-container { display:grid; grid-template-columns: 400px 1fr; gap:15px; padding:15px; height:100vh; }
    .card { background:var(--panel); border:1px solid #22324a; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .scroll-y { overflow-y:auto; flex:1; padding:15px; }
    .header-p { padding:15px; border-bottom:1px solid #22324a; background:rgba(0,0,0,0.2); }
    
    h1 { margin:0 0 5px 0; font-size:18px; color:var(--accent); }
    input, select, button { width:100%; background:#0e1522; border:1px solid #22324a; color:var(--text); border-radius:6px; padding:10px; margin-bottom:10px; outline:none; }
    button { cursor:pointer; font-weight:600; transition: 0.2s; border:none; background:#1a273b; color: var(--text); }
    button:hover { background: #22324a; }
    .primary { background: var(--accent); color:#0b0f14; }
    .success { background: var(--ok); color:#0b0f14; }
    .danger { background: var(--danger); color:#fff; }
    
    .q-item { padding:12px; border-bottom:1px solid #22324a; background: rgba(255,255,255,0.02); margin-bottom:5px; border-radius:6px; }
    .progress-container { width: 100%; background: #000; height: 8px; border-radius:4px; margin-top:8px; display:none; overflow:hidden; border:1px solid #22324a; }
    .progress-bar { height:100%; background:var(--accent); width:0%; transition: width 0.2s; }
    .status-tag { font-size:11px; color:var(--muted); margin-top:4px; display:block; }
    
    .item { padding:10px; border-bottom:1px solid #1d2a3d; display:flex; justify-content:space-between; align-items:center; }
    .item:hover { background:rgba(255,255,255,0.03); }
    .warn-box { background:rgba(255,211,107,0.1); border:1px solid var(--warn); color:var(--warn); padding:10px; border-radius:6px; font-size:11px; margin-bottom:15px; }
    
    .tabs { display:flex; gap:5px; margin-bottom:15px; }
    .tab { flex:1; padding:8px; text-align:center; background:#0e1522; border-radius:6px; cursor:pointer; color:var(--muted); font-size:12px; border: 1px solid #22324a; }
    .tab.active { background:var(--accent); color:#000; font-weight:bold; border: none; }
    .badge { background: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: var(--accent); margin-right: 5px; }
    
    .back-btn { background: #22324a; padding: 5px 10px; border-radius: 4px; color: var(--accent); cursor: pointer; display: inline-block; margin-bottom: 10px; font-size: 11px; }
  </style>
</head>
<body>

<div class="app-container">
  <aside class="card">
    <div class="header-p">
        <h1>Xstream Pro</h1>
        <div style="font-size: 11px; color: var(--muted);">v2.1 - Manuel Bölüm Seçimi</div>
    </div>
    <div class="scroll-y">
      <div class="warn-box">
        <strong>Not:</strong> CORS Unblock eklentisini açmayı unutmayın.
      </div>
      <input id="host" placeholder="http://iptv-adresi.com:8080" />
      <input id="user" placeholder="Kullanıcı Adı" />
      <input id="pass" type="password" placeholder="Şifre" />
      <button id="btnConnect" class="primary">Sunucuya Bağlan</button>
      
      <hr style="border:0; border-top:1px solid #22324a; margin:20px 0;">
      
      <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="font-size:14px; margin:0;">Kuyruk (<span id="qCount">0</span>)</h3>
        <button id="btnClearQ" class="danger" style="width:auto; padding:4px 8px; font-size:10px; margin:0;">Temizle</button>
      </div>
      <button id="btnRunNow" class="success">Klasör Seç & Başlat</button>
      <div id="queueList"></div>
    </div>
  </aside>

  <main class="card">
    <div class="header-p">
        <div class="tabs">
            <div id="tabVod" class="tab active" onclick="setMode('vod')">Filmler</div>
            <div id="tabSeries" class="tab" onclick="setMode('series')">Diziler</div>
            <div id="tabEps" class="tab" style="display:none;" onclick="setMode('episodes')">Bölüm Seçimi</div>
        </div>
        <div id="filterArea" style="display:grid; grid-template-columns: 1fr 200px; gap:10px;">
            <input id="search" placeholder="Ara..." />
            <select id="category"><option value="">Kategori Seçin</option></select>
        </div>
    </div>
    <div class="scroll-y" id="contentList">
        <div style="text-align:center; padding:50px; color:var(--muted);">Sunucuya bağlanın.</div>
    </div>
  </main>
</div>

<script>
const state = { 
    mode: 'vod', 
    vods: [], series: [], episodes: [], 
    catsVod: [], catsSer: [],
    queue: [], running: false,
    activeSeriesName: ''
};

const $ = id => document.getElementById(id);

// --- API ---
async function api(action, params = "") {
    const host = $('host').value.replace(/\/+$/, "");
    const url = `${host}/player_api.php?username=${$('user').value}&password=${$('pass').value}&action=${action}${params}`;
    const res = await fetch(url);
    return res.json();
}

$('btnConnect').onclick = async () => {
    try {
        $('btnConnect').innerText = "Bağlanıyor...";
        const [cv, v, cs, s] = await Promise.all([
            api('get_vod_categories'), api('get_vod_streams'),
            api('get_series_categories'), api('get_series')
        ]);
        state.catsVod = cv || []; state.vods = v || [];
        state.catsSer = cs || []; state.series = s || [];
        setMode('vod');
        $('btnConnect').innerText = "Bağlandı";
    } catch (e) {
        alert("Bağlantı Hatası!");
        $('btnConnect').innerText = "Tekrar Dene";
    }
};

// --- MODLAR ---
function setMode(m) {
    state.mode = m;
    $('tabVod').classList.toggle('active', m === 'vod');
    $('tabSeries').classList.toggle('active', m === 'series');
    $('tabEps').classList.toggle('active', m === 'episodes');
    
    if (m === 'episodes') {
        $('tabEps').style.display = 'block';
        $('filterArea').style.display = 'none';
    } else {
        $('tabEps').style.display = 'none';
        $('filterArea').style.display = 'grid';
    }
    renderList();
}

function renderList() {
    const term = $('search').value.toLowerCase();
    const cat = $('category').value;
    let data = (state.mode === 'vod') ? state.vods : (state.mode === 'series' ? state.series : state.episodes);
    
    if (state.mode !== 'episodes') {
        data = data.filter(item => {
            return (item.name||"").toLowerCase().includes(term) && (cat === "" || item.category_id === cat);
        });
    }

    let html = "";
    if (state.mode === 'episodes') {
        html += `<div class="back-btn" onclick="setMode('series')">← Dizilere Dön</div>`;
        html += `<h2 style="font-size:16px; margin-bottom:15px;">${state.activeSeriesName} - Bölüm Listesi</h2>`;
    }

    html += data.slice(0, 500).map(item => {
        const name = item.name || item.title;
        const id = item.stream_id || item.series_id || item.id;
        
        let btn = "";
        if (state.mode === 'vod') {
            btn = `<button onclick="addQ('${id}','vod','${esc(name)}','${item.container_extension}')" class="primary" style="width:auto; padding:5px 12px;">+</button>`;
        } else if (state.mode === 'series') {
            btn = `<button onclick="loadEps('${id}','${esc(name)}')" class="primary" style="width:auto; padding:5px 12px;">Bölümleri Gör</button>`;
        } else {
            btn = `<button onclick="addQ('${id}','series','${esc(name)}','${item.container_extension}','${item.season}','${item.episode_num}')" class="primary" style="width:auto; padding:5px 12px;">+</button>`;
        }

        return `
            <div class="item">
                <div>
                    <span class="badge">${state.mode === 'episodes' ? 'S'+item.season+' E'+item.episode_num : state.mode.toUpperCase()}</span>
                    <strong>${name}</strong>
                </div>
                ${btn}
            </div>`;
    }).join('');
    
    $('contentList').innerHTML = html;
    
    if (state.mode !== 'episodes') {
        const cats = state.mode === 'vod' ? state.catsVod : state.catsSer;
        $('category').innerHTML = '<option value="">Tüm Kategoriler</option>' + 
            cats.map(c => `<option value="${c.category_id}">${c.category_name}</option>`).join('');
    }
}

// --- İŞLEMLER ---
const esc = s => (s||"").replace(/'/g, "\\'");

window.loadEps = async (sId, sName) => {
    const info = await api('get_series_info', `&series_id=${sId}`);
    state.activeSeriesName = sName;
    state.episodes = [];
    Object.keys(info.episodes).forEach(sNum => {
        info.episodes[sNum].forEach(ep => state.episodes.push({...ep, season: sNum}));
    });
    setMode('episodes');
};

window.addQ = (id, type, name, ext, s, e) => {
    const h = $('host').value.replace(/\/+$/, "");
    const u = $('user').value;
    const p = $('pass').value;
    const fileName = type === 'vod' ? `${name}.${ext||'mp4'}` : `${state.activeSeriesName} - S${String(s).padStart(2,'0')}E${String(e).padStart(2,'0')}.${ext||'mp4'}`;
    const url = type === 'vod' ? `${h}/movie/${u}/${p}/${id}.${ext||'mp4'}` : `${h}/series/${u}/${p}/${id}.${ext||'mp4'}`;
    
    state.queue.push({ name: fileName, url, status: 'Bekliyor' });
    renderQueue();
};

function renderQueue() {
    $('qCount').innerText = state.queue.length;
    $('queueList').innerHTML = state.queue.map((item, i) => `
        <div class="q-item">
            <div style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.name}</div>
            <span class="status-tag" id="st-${i}">${item.status}</span>
            <div class="progress-container" id="pc-${i}"><div class="progress-bar" id="pb-${i}"></div></div>
        </div>
    `).reverse().join('');
}

$('btnClearQ').onclick = () => { state.queue = []; renderQueue(); };

// --- İNDİRME MOTORU ---
$('btnRunNow').onclick = async () => {
    if (state.running || state.queue.length === 0) return;
    try {
        const dir = await window.showDirectoryPicker({ mode: 'readwrite' });
        state.running = true;
        for (let i = 0; i < state.queue.length; i++) {
            const item = state.queue[i];
            if (item.status !== 'Bekliyor') continue;

            const pb = document.getElementById(`pb-${i}`);
            const pc = document.getElementById(`pc-${i}`);
            const st = document.getElementById(`st-${i}`);
            if(pc) pc.style.display = 'block';

            try {
                const res = await fetch(item.url);
                const reader = res.body.getReader();
                const total = +res.headers.get('Content-Length');
                const file = await dir.getFileHandle(item.name.replace(/[/\\?%*:|"<>]/g, '-'), { create: true });
                const writable = await file.createWritable();

                let loaded = 0;
                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    await writable.write(value);
                    loaded += value.length;
                    if (total && pb) {
                        const pct = Math.round((loaded / total) * 100);
                        pb.style.width = pct + '%';
                        st.innerText = `%${pct} indirildi`;
                    }
                }
                await writable.close();
                item.status = "TAMAMLANDI";
                st.style.color = "var(--ok)";
            } catch (err) { item.status = "Hata!"; }
            st.innerText = item.status;
        }
        state.running = false;
        alert("Bitti!");
    } catch (e) { state.running = false; }
};

$('search').oninput = renderList;
$('category').onchange = renderList;
</script>
</body>
</html>
