<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xstream Pro Downloader</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121926; --muted:#93a4bd; --text:#e7eefc; --accent:#7aa2ff; --danger:#ff6b6b; --ok:#4ade80; --warn:#ffd36b; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); font-size:13px; overflow:hidden; }
    
    .app-container { display:grid; grid-template-columns: 400px 1fr; gap:15px; padding:15px; height:100vh; }
    .card { background:var(--panel); border:1px solid #22324a; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .scroll-y { overflow-y:auto; flex:1; padding:15px; }
    .header-p { padding:15px; border-bottom:1px solid #22324a; background:rgba(0,0,0,0.2); }
    
    h1 { margin:0 0 10px 0; font-size:18px; color:var(--accent); }
    input, select, button { width:100%; background:#0e1522; border:1px solid #22324a; color:var(--text); border-radius:6px; padding:10px; margin-bottom:10px; outline:none; }
    button { cursor:pointer; font-weight:600; transition: 0.2s; border:none; background:#1a273b; }
    button:hover { background: #22324a; }
    .primary { background: var(--accent); color:#0b0f14; }
    .success { background: var(--ok); color:#0b0f14; }
    
    .q-item { padding:12px; border-bottom:1px solid #22324a; background: rgba(255,255,255,0.02); margin-bottom:5px; border-radius:6px; }
    .progress-container { width: 100%; background: #000; height: 8px; border-radius:4px; margin-top:8px; display:none; overflow:hidden; border:1px solid #22324a; }
    .progress-bar { height:100%; background:var(--accent); width:0%; transition: width 0.2s; }
    .status-tag { font-size:11px; color:var(--muted); margin-top:4px; display:block; }
    
    .item { padding:10px; border-bottom:1px solid #1d2a3d; display:flex; justify-content:space-between; align-items:center; }
    .item:hover { background:rgba(255,255,255,0.03); }
    .warn-box { background:rgba(255,211,107,0.1); border:1px solid var(--warn); color:var(--warn); padding:10px; border-radius:6px; font-size:11px; margin-bottom:15px; }
    
    .tabs { display:flex; gap:5px; margin-bottom:15px; }
    .tab { flex:1; padding:8px; text-align:center; background:#0e1522; border-radius:6px; cursor:pointer; color:var(--muted); font-size:12px; }
    .tab.active { background:var(--accent); color:#000; font-weight:bold; }
  </style>
</head>
<body>

<div class="app-container">
  <aside class="card">
    <div class="header-p"><h1>Ayarlar</h1></div>
    <div class="scroll-y">
      <div class="warn-box">
        <strong>İpucu:</strong> İndirme başlamazsa tarayıcı eklentilerinden <b>CORS Unblock</b>'u aktif edin.
      </div>
      <input id="host" placeholder="http://iptv-adresi.com:8080" />
      <input id="user" placeholder="Kullanıcı Adı" />
      <input id="pass" type="password" placeholder="Şifre" />
      <button id="btnConnect" class="primary">Sunucuya Bağlan</button>
      
      <hr style="border:0; border-top:1px solid #22324a; margin:20px 0;">
      
      <h3 style="font-size:14px; margin-bottom:10px;">İndirme Kuyruğu</h3>
      <button id="btnRunNow" class="success">Klasör Seç & Kuyruğu Başlat</button>
      <div id="queueList"></div>
    </div>
  </aside>

  <main class="card">
    <div class="header-p">
        <div class="tabs">
            <div class="tab active" onclick="setMode('vod')">Filmler</div>
            <div class="tab" onclick="setMode('series')">Diziler</div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 200px; gap:10px;">
            <input id="search" placeholder="İsimle ara..." />
            <select id="category"><option value="">Kategori Seçin</option></select>
        </div>
    </div>
    <div class="scroll-y" id="contentList">
        <div style="text-align:center; padding:50px; color:var(--muted);">Lütfen önce sunucuya bağlanın.</div>
    </div>
  </main>
</div>

<script>
const state = { 
    mode: 'vod', 
    vods: [], series: [], episodes: [], 
    catsVod: [], catsSer: [],
    queue: [], running: false 
};

const $ = id => document.getElementById(id);

// --- API İŞLEMLERİ ---
async function api(action, params = "") {
    const host = $('host').value.replace(/\/+$/, "");
    const url = `${host}/player_api.php?username=${$('user').value}&password=${$('pass').value}&action=${action}${params}`;
    const res = await fetch(url);
    return res.json();
}

$('btnConnect').onclick = async () => {
    try {
        $('btnConnect').innerText = "Yükleniyor...";
        const [cv, v, cs, s] = await Promise.all([
            api('get_vod_categories'), api('get_vod_streams'),
            api('get_series_categories'), api('get_series')
        ]);
        state.catsVod = cv; state.vods = v;
        state.catsSer = cs; state.series = s;
        updateCategories();
        renderList();
        $('btnConnect').innerText = "Bağlantı Başarılı";
        setTimeout(() => $('btnConnect').innerText = "Tekrar Bağlan", 2000);
    } catch (e) {
        alert("Bağlantı hatası! Bilgileri ve CORS eklentisini kontrol edin.");
        $('btnConnect').innerText = "Hata Oluştu";
    }
};

// --- LİSTELEME ---
function setMode(m) {
    state.mode = m;
    document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', (i===0 && m==='vod') || (i===1 && m==='series')));
    updateCategories();
    renderList();
}

function updateCategories() {
    const cats = state.mode === 'vod' ? state.catsVod : state.catsSer;
    $('category').innerHTML = '<option value="">Tüm Kategoriler</option>' + 
        cats.map(c => `<option value="${c.category_id}">${c.category_name}</option>`).join('');
}

function renderList() {
    const term = $('search').value.toLowerCase();
    const cat = $('category').value;
    const data = state.mode === 'vod' ? state.vods : state.series;
    
    const filtered = data.filter(item => {
        const name = (item.name || "").toLowerCase();
        return name.includes(term) && (cat === "" || item.category_id === cat);
    });

    $('contentList').innerHTML = filtered.slice(0, 300).map(item => `
        <div class="item">
            <div>
                <strong>${item.name}</strong>
                <div style="font-size:10px; color:var(--muted)">${state.mode.toUpperCase()}</div>
            </div>
            <button onclick="${state.mode === 'vod' ? `addVod('${item.stream_id}', '${item.name.replace(/'/g,"")}', '${item.container_extension}')` : `loadEpisodes('${item.series_id}', '${item.name.replace(/'/g,"")}')`}" style="width:auto; padding:5px 15px;" class="primary">+</button>
        </div>
    `).join('');
}

// --- KUYRUK VE İNDİRME ---
window.addVod = (id, name, ext) => {
    const host = $('host').value.replace(/\/+$/, "");
    const url = `${host}/movie/${$('user').value}/${$('pass').value}/${id}.${ext || 'mp4'}`;
    state.queue.push({ name: `${name}.${ext || 'mp4'}`, url, status: 'Bekliyor' });
    renderQueue();
};

window.loadEpisodes = async (sId, sName) => {
    const info = await api('get_series_info', `&series_id=${sId}`);
    const host = $('host').value.replace(/\/+$/, "");
    
    Object.keys(info.episodes).forEach(season => {
        info.episodes[season].forEach(ep => {
            const fileName = `${sName}_S${season.padStart(2,'0')}E${String(ep.episode_num).padStart(2,'0')}.${ep.container_extension}`;
            const url = `${host}/series/${$('user').value}/${$('pass').value}/${ep.id}.${ep.container_extension}`;
            state.queue.push({ name: fileName, url, status: 'Bekliyor' });
        });
    });
    renderQueue();
    alert("Dizi bölümleri kuyruğa eklendi!");
};

function renderQueue() {
    $('queueList').innerHTML = state.queue.map((item, i) => `
        <div class="q-item">
            <div style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.name}</div>
            <span class="status-tag">${item.status}</span>
            <div class="progress-container"><div class="progress-bar" id="pb-${i}"></div></div>
        </div>
    `).reverse().join('');
}

// --- ANA İNDİRME MOTORU (Sıralı ve Akıllı İsimlendirme) ---
$('btnRunNow').onclick = async () => {
    if (state.running) return;
    if (!('showDirectoryPicker' in window)) return alert("Lütfen Chrome veya Edge kullanın!");

    try {
        const dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        state.running = true;
        
        // Kuyruğu baştan sona tara
        for (let i = 0; i < state.queue.length; i++) {
            const item = state.queue[i];
            if (item.status !== 'Bekliyor') continue;

            const pb = document.getElementById(`pb-${i}`);
            if(pb) pb.parentElement.style.display = 'block';
            item.status = "İndiriliyor...";
            renderQueue();

            try {
                const res = await fetch(item.url);
                const reader = res.body.getReader();
                const total = +res.headers.get('Content-Length');
                
                const fileHandle = await dirHandle.getFileHandle(item.name.replace(/[/\\?%*:|"<>]/g, '-'), { create: true });
                const writable = await fileHandle.createWritable();

                let loaded = 0;
                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    await writable.write(value);
                    loaded += value.length;
                    if (total && pb) {
                        const pct = Math.round((loaded / total) * 100);
                        pb.style.width = pct + '%';
                    }
                }
                await writable.close();
                item.status = "TAMAMLANDI";
            } catch (err) {
                item.status = "Hata!";
            }
            renderQueue();
        }
        state.running = false;
        alert("Tüm indirmeler bitti!");
    } catch (e) {
        console.error(e);
    }
};

$('search').oninput = renderList;
$('category').onchange = renderList;
</script>
</body>
</html>
